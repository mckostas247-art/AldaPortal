@model List<PortalBase.Core.Entities.Scholarship>
@{
    ViewData["Title"] = "Scholarships - Find Your Perfect Educational Opportunity";
}

<section class="hero-gradient text-white py-16">
    <div class="container mx-auto px-4">
        <div class="max-w-3xl mx-auto text-center">
            <h1 class="text-4xl md:text-5xl font-montserrat font-bold mb-4">Find Your Perfect Scholarship</h1>
            <p class="text-xl text-gray-300">
                Discover thousands of scholarship opportunities from around the world. Filter by country, field of study, and more.
            </p>
        </div>
    </div>
</section>

<section class="py-12 bg-alda-light">
    <div class="container mx-auto px-4">
        <form method="get" asp-controller="Scholarships" asp-action="Index" class="max-w-6xl mx-auto">
            <!-- Sticky Filter Header -->
            <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-sm shadow-lg rounded-t-xl border-b-2 border-alda-gold">
                <div class="p-4 md:p-6">
                    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
                        <!-- Search Bar -->
                        <div class="flex-1 w-full md:max-w-md">
                            <label class="block text-xs font-semibold text-alda-dark mb-1">Search Scholarships</label>
                            <input type="text" name="search" value="@ViewBag.Search" placeholder="Search by title, description, country, or field..." 
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-alda-gold focus:border-alda-gold text-base">
                        </div>
                        
                        <!-- Toggle Button -->
                        <div class="flex items-center gap-2">
                            <button type="button" id="toggleFilters" class="btn-secondary flex items-center gap-2">
                                <span id="toggleText" class="hidden md:inline">Show Filters</span>
                                <svg id="toggleIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                                @{
                                    var activeFiltersCount = 0;
                                    if (!string.IsNullOrWhiteSpace(ViewBag.Country?.ToString())) activeFiltersCount++;
                                    if (!string.IsNullOrWhiteSpace(ViewBag.FieldOfStudy?.ToString())) activeFiltersCount++;
                                    if (!string.IsNullOrWhiteSpace(ViewBag.DegreeLevel?.ToString())) activeFiltersCount++;
                                }
                                @if (activeFiltersCount > 0)
                                {
                                    <span class="px-2 py-1 bg-alda-gold text-alda-dark text-xs font-bold rounded-full">@activeFiltersCount</span>
                                }
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Collapsible Filter Section -->
                <div id="filterSection" class="hidden px-4 md:px-6 pb-4 md:pb-6 border-t border-gray-200">
                    <div class="pt-4 md:pt-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-alda-dark mb-2">Country</label>
                                <select name="country" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-alda-gold focus:border-alda-gold text-base">
                                    <option value="">All Countries</option>
                                    @foreach (var country in (List<string>)ViewBag.Countries)
                                    {
                                        <option value="@country" selected="@(ViewBag.Country == country)">@country</option>
                                    }
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-alda-dark mb-2">Field of Study</label>
                                <select name="fieldOfStudy" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-alda-gold focus:border-alda-gold text-base">
                                    <option value="">All Fields</option>
                                    @foreach (var field in (List<string>)ViewBag.FieldsOfStudy)
                                    {
                                        <option value="@field" selected="@(ViewBag.FieldOfStudy == field)">@field</option>
                                    }
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-alda-dark mb-2">Degree Level</label>
                                <select name="degreeLevel" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-alda-gold focus:border-alda-gold text-base">
                                    <option value="">All Levels</option>
                                    @foreach (var level in (List<string>)ViewBag.DegreeLevels)
                                    {
                                        <option value="@level" selected="@(ViewBag.DegreeLevel == level)">@level</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Bar -->
                <div class="px-4 md:px-6 py-3 border-t border-gray-200 bg-gray-50">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                        <div class="flex items-center gap-3">
                            <span class="text-lg font-bold text-alda-dark">@ViewBag.TotalCount</span>
                            <span class="text-alda-gray">Scholarships Found</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-sm text-alda-gray">Sort by:</label>
                            <select name="sort" onchange="this.form.submit()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-alda-gold focus:border-alda-gold text-sm">
                                <option value="" selected="@(string.IsNullOrEmpty(ViewBag.Sort))">Deadline (Soonest)</option>
                                <option value="deadline_desc" selected="@(ViewBag.Sort == "deadline_desc")">Deadline (Furthest)</option>
                                <option value="amount_desc" selected="@(ViewBag.Sort == "amount_desc")">Amount (Highest)</option>
                                <option value="amount_asc" selected="@(ViewBag.Sort == "amount_asc")">Amount (Lowest)</option>
                                <option value="country_asc" selected="@(ViewBag.Sort == "country_asc")">Country (A-Z)</option>
                            </select>
                        </div>
                        @if (activeFiltersCount > 0 || !string.IsNullOrWhiteSpace(ViewBag.Search?.ToString()) || !string.IsNullOrWhiteSpace(ViewBag.Sort?.ToString()))
                        {
                            <a asp-controller="Scholarships" asp-action="Index" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm font-semibold">
                                Clear All
                            </a>
                        }
                    </div>
                </div>
            </div>

            <!-- Hidden Submit Button -->
            <button type="submit" class="hidden">Search</button>
        </form>
    </div>
</section>

<section class="py-12 bg-white">
    <div class="container mx-auto px-4">
        @if (Model.Any())
        {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                @foreach (var scholarship in Model)
                {
                    <div class="card hover:shadow-xl transition-shadow relative">
                        @if (scholarship.IsFeatured)
                        {
                            <div class="absolute -top-3 -right-3 z-10">
                                <span class="bg-alda-gold text-alda-dark text-xs font-bold px-3 py-1 rounded-full shadow-md">FEATURED</span>
                            </div>
                        }
                        <div class="flex justify-between items-start mb-3">
                            <span class="px-3 py-1 bg-alda-gold text-alda-dark text-sm font-semibold rounded">@scholarship.Country</span>
                            <span class="text-sm text-alda-gray">@scholarship.DegreeLevel</span>
                        </div>
                        <h3 class="text-xl font-montserrat font-semibold text-alda-dark mb-2 line-clamp-2">
                            <a asp-controller="Scholarships" asp-action="Details" asp-route-id="@scholarship.Id" class="hover:text-alda-gold transition-colors">@scholarship.Title</a>
                        </h3>
                        <p class="text-alda-gray mb-4 line-clamp-3">@scholarship.Description</p>
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <div class="text-lg font-bold text-alda-dark">@scholarship.Amount.ToString("C0")</div>
                                <div class="text-sm text-alda-gray">@scholarship.Currency</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-alda-dark">Deadline</div>
                                <div class="text-sm text-alda-gray">@scholarship.Deadline.ToString("MMM dd, yyyy")</div>
                            </div>
                        </div>
                        <a asp-controller="Scholarships" asp-action="Details" asp-route-id="@scholarship.Id" class="btn-primary w-full text-center block">View Details</a>
                    </div>
                }
            </div>

            @if (ViewBag.TotalPages > 1)
            {
                <div class="mt-8 flex justify-center gap-2">
                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <a asp-controller="Scholarships" asp-action="Index" 
                           asp-route-page="@i" 
                           asp-route-search="@ViewBag.Search" 
                           asp-route-country="@ViewBag.Country" 
                           asp-route-fieldOfStudy="@ViewBag.FieldOfStudy" 
                           asp-route-degreeLevel="@ViewBag.DegreeLevel" 
                           asp-route-sort="@ViewBag.Sort"
                           class="px-4 py-2 @(ViewBag.CurrentPage == i ? "bg-alda-gold text-alda-dark" : "bg-white text-alda-dark") border border-gray-300 rounded-lg hover:bg-alda-gold hover:text-alda-dark transition-colors">
                            @i
                        </a>
                    }
                </div>
            }
        }
        else
        {
            <div class="text-center py-12">
                <p class="text-alda-gray text-lg mb-4">No scholarships found matching your criteria.</p>
                <a asp-controller="Scholarships" asp-action="Index" class="btn-primary">View All Scholarships</a>
            </div>
        }
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButton = document.getElementById('toggleFilters');
        const filterSection = document.getElementById('filterSection');
        const toggleText = document.getElementById('toggleText');
        const toggleIcon = document.getElementById('toggleIcon');
        
        // Check if filters are active on page load
        const urlParams = new URLSearchParams(window.location.search);
        const hasFilters = urlParams.has('country') || urlParams.has('fieldOfStudy') || urlParams.has('degreeLevel');
        
        if (hasFilters) {
            filterSection.classList.remove('hidden');
            toggleText.textContent = 'Hide Filters';
            toggleIcon.style.transform = 'rotate(180deg)';
        }
        
        toggleButton.addEventListener('click', function() {
            const isHidden = filterSection.classList.contains('hidden');
            
            if (isHidden) {
                filterSection.classList.remove('hidden');
                filterSection.style.maxHeight = filterSection.scrollHeight + 'px';
                toggleText.textContent = 'Hide Filters';
                toggleIcon.style.transform = 'rotate(180deg)';
            } else {
                filterSection.style.maxHeight = '0';
                setTimeout(() => {
                    filterSection.classList.add('hidden');
                }, 300);
                toggleText.textContent = 'Show Filters';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        });
        
        // Auto-submit form on filter change
        const filterInputs = filterSection.querySelectorAll('select');
        filterInputs.forEach(input => {
            input.addEventListener('change', function() {
                this.form.submit();
            });
        });
    });
</script>

<style>
    #filterSection {
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        overflow: hidden;
    }
    
    #toggleIcon {
        transition: transform 0.3s ease;
    }
</style>
